<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ADR ุงูุตูุงูุฉ">
    <title>ูุธุงู ุฅุฏุงุฑุฉ ุงูุตูุงูุฉ - ADR</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/icon-32x32.png') }}">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1>๐ฑ ูุธุงู ุฅุฏุงุฑุฉ ุงูุตูุงูุฉ</h1>
            <p>ADR ELECTRONICS</p>
            <div class="header-actions">
                <button class="logout-btn" onclick="logout()" title="ุชุณุฌูู ุงูุฎุฑูุฌ">
                    ๐ช ุฎุฑูุฌ
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <button class="nav-btn active" data-section="dashboard" type="button">
            <span class="nav-icon">๐</span>
            <span class="nav-text">ุงูุชุญูู</span>
        </button>
        <button class="nav-btn" data-section="jobs" type="button">
            <span class="nav-icon">๐</span>
            <span class="nav-text">ุงูุทูุจุงุช</span>
        </button>
        <button class="nav-btn" data-section="add" type="button">
            <span class="nav-icon">โ</span>
            <span class="nav-text">ุฅุถุงูุฉ</span>
        </button>
        <button class="nav-btn" data-section="camera" type="button">
            <span class="nav-icon">๐ท</span>
            <span class="nav-text">ูุงููุฑุง</span>
        </button>
        <button class="nav-btn" data-section="reports" type="button">
            <span class="nav-icon">๐</span>
            <span class="nav-text">ุงูุชูุงุฑูุฑ</span>
        </button>
        <button class="nav-btn" data-section="settings" type="button">
            <span class="nav-icon">โ๏ธ</span>
            <span class="nav-text">ุฅุนุฏุงุฏุงุช</span>
        </button>
    </nav>

    <!-- Dashboard Section -->
    <section id="dashboard" class="section active">
        <div class="container">
            <h2>๐ ููุญุฉ ุงูุชุญูู</h2>
            
            <div class="stats-grid">
                <div class="stat-card clickable" onclick="filterJobsByStatus('')" title="ุงุถุบุท ูุนุฑุถ ุฌููุน ุงูุทูุจุงุช">
                    <div class="stat-icon">๐</div>
                    <div class="stat-value" id="total-jobs">0</div>
                    <div class="stat-label">ุฅุฌูุงูู ุงูุทูุจุงุช</div>
                </div>
                
                <div class="stat-card clickable" onclick="filterJobsByStatus('received')" title="ุงุถุบุท ูุนุฑุถ ุงูุทูุจุงุช ููุฏ ุงููุนุงูุฌุฉ">
                    <div class="stat-icon">โณ</div>
                    <div class="stat-value" id="in-progress">0</div>
                    <div class="stat-label">ููุฏ ุงููุนุงูุฌุฉ</div>
                </div>
                
                <div class="stat-card clickable" onclick="filterJobsByStatus('repaired')" title="ุงุถุบุท ูุนุฑุถ ุงูุทูุจุงุช ุงูุฌุงูุฒุฉ">
                    <div class="stat-icon">โ</div>
                    <div class="stat-value" id="ready">0</div>
                    <div class="stat-label">ุฌุงูุฒ ููุชุณููู</div>
                </div>
                
                <div class="stat-card clickable" onclick="filterJobsByStatus('delivered')" title="ุงุถุบุท ูุนุฑุถ ุงูุทูุจุงุช ุงููุณููุฉ">
                    <div class="stat-icon">๐</div>
                    <div class="stat-value" id="delivered">0</div>
                    <div class="stat-label">ุชู ุงูุชุณููู</div>
                </div>
            </div>

            <div class="recent-jobs">
                <h3>ุขุฎุฑ ุงูุทูุจุงุช</h3>
                <div id="recent-jobs-list"></div>
            </div>
        </div>
    </section>

    <!-- Jobs Section -->
    <section id="jobs" class="section">
        <div class="container">
            <h2>๐ ุฌููุน ุงูุทูุจุงุช</h2>
            
            <!-- Search -->
            <div class="search-box">
                <input type="text" id="search-input" placeholder="๐ ุงุจุญุซ ุจุฑูู ุงูุชุชุจุนุ ุงุณู ุงูุนูููุ ุฃู ุฑูู ุงููุงุชู...">
                <select id="status-filter">
                    <option value="">ุฌููุน ุงูุญุงูุงุช</option>
                    <option value="received">ุชู ุงูุงุณุชูุงู</option>
                    <option value="repaired">ุชูุช ุงูุตูุงูุฉ</option>
                    <option value="delivered">ุชู ุงูุชุณููู</option>
                </select>
            </div>

            <!-- Jobs List -->
            <div id="jobs-list"></div>
        </div>
    </section>

    <!-- Add Job Section -->
    <section id="add" class="section">
        <div class="container">
            <h2>โ ุฅุถุงูุฉ ุทูุจ ุตูุงูุฉ ุฌุฏูุฏ</h2>
            
            <form id="add-job-form">
                <div class="form-group">
                    <label>ุงุณู ุงูุนููู *</label>
                    <input type="text" id="customer-name" required>
                </div>

                <div class="form-group">
                    <label>ุฑูู ุงููุงุชู *</label>
                    <input type="tel" id="phone" required>
                </div>

                <div class="form-group">
                    <label>ููุน ุงูุฌูุงุฒ *</label>
                    <input type="text" id="device-type" required>
                </div>

                <div class="form-group">
                    <label>ููุฏูู ุงูุฌูุงุฒ</label>
                    <input type="text" id="device-model">
                </div>

                <div class="form-group">
                    <label>ุงูุฑูู ุงูุชุณูุณูู</label>
                    <input type="text" id="serial-number" lang="en" inputmode="verbatim" dir="ltr">
                </div>

                <div class="form-group">
                    <label>ูุตู ุงูุนุทู</label>
                    <textarea id="issue-description" rows="4" placeholder="ูุตู ุงูุนุทู (ุงุฎุชูุงุฑู)"></textarea>
                </div>

                <div class="form-group">
                    <label>ุงูุชูููุฉ ุงูุชูุฏูุฑูุฉ</label>
                    <div class="cost-input-group">
                        <input type="number" id="estimated-cost" min="0" step="0.01" placeholder="ูุซุงู: 50">
                        <select id="estimated-cost-currency">
                            <option value="USD">$ ุฏููุงุฑ (ููุถู)</option>
                            <option value="LBP">ู.ู ููุฑุฉ ูุจูุงููุฉ</option>
                        </select>
                    </div>
                    <div id="cost-conversion" class="cost-conversion"></div>
                </div>

                <div class="form-group">
                    <label>ุทุฑููุฉ ุงูุฏูุน ุงูููุถูุฉ</label>
                    <div class="payment-methods">
                        <label class="payment-option">
                            <input type="radio" name="payment-method" value="cash" checked>
                            <span class="payment-label">๐ต ูุงุด (ููุถู)</span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="payment-method" value="wish_money">
                            <span class="payment-label">๐ณ Wish Money</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>ููุงุญุธุงุช</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">๐พ ุญูุธ ุงูุทูุจ</button>
            </form>
        </div>
    </section>

    <!-- Camera Section -->
    <section id="camera" class="section">
        <div class="container">
            <h2>๐ท ูุงููุฑุง ุงููุงุชู</h2>
            
            <div class="camera-controls">
                <button class="btn btn-primary" onclick="openCamera()">
                    ๐ท ูุชุญ ุงููุงููุฑุง
                </button>
                <button class="btn btn-secondary" onclick="capturePhoto()" id="capture-btn" disabled>
                    ๐ธ ุงูุชูุงุท ุตูุฑุฉ
                </button>
            </div>
            
            <div class="camera-preview">
                <video id="camera-video" autoplay playsinline style="display: none;"></video>
                <canvas id="camera-canvas" style="display: none;"></canvas>
                <div id="photo-preview" class="photo-preview"></div>
            </div>
            
            <div class="photo-actions" id="photo-actions" style="display: none;">
                <button class="btn btn-success" onclick="savePhoto()">
                    ๐พ ุญูุธ ุงูุตูุฑุฉ
                </button>
                <button class="btn btn-danger" onclick="retakePhoto()">
                    ๐ ุฅุนุงุฏุฉ ุงูุชูุงุท
                </button>
            </div>
        </div>
    </section>

    <!-- Reports Section -->
    <section id="reports" class="section">
        <div class="container">
            <h2>๐ ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช</h2>
            
            <!-- Report Filters -->
            <div class="report-filters">
                <div class="filter-group">
                    <label>ููุน ุงูุชูุฑูุฑ</label>
                    <select id="report-type">
                        <option value="daily">ูููู</option>
                        <option value="weekly">ุฃุณุจูุนู</option>
                        {% if enable_monthly_stats %}
                        <option value="monthly">ุดูุฑู</option>
                        {% endif %}
                        <option value="yearly">ุณููู</option>
                        <option value="custom">ูุฎุตุต</option>
                    </select>
                </div>
                
                <div class="filter-group" id="custom-dates" style="display: none;">
                    <label>ูู ุชุงุฑูุฎ</label>
                    <input type="date" id="start-date">
                    <label>ุฅูู ุชุงุฑูุฎ</label>
                    <input type="date" id="end-date">
                </div>
                
                <div class="filter-group">
                    <label>ููุน ุงูููุฏ</label>
                    <select id="report-code-type">
                        <option value="">ุฌููุน ุงูุฃููุงุน</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>ุงูุญุงูุฉ</label>
                    <select id="report-status">
                        <option value="delivered">ุชู ุงูุชุณููู</option>
                        <option value="all">ุฌููุน ุงูุญุงูุงุช</option>
                        <option value="received">ุชู ุงูุงุณุชูุงู</option>
                        <option value="repaired">ุชูุช ุงูุตูุงูุฉ</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="generateReport()">
                    ๐ ุฅูุดุงุก ุงูุชูุฑูุฑ
                </button>
            </div>
            
            <!-- Report Results -->
            <div id="report-results" style="display: none;">
                <!-- Report Header with Time Info -->
                <div class="report-header" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-right: 4px solid #667eea;">
                    <h3 style="margin: 0 0 10px 0; color: #333;">๐ ูุชุงุฆุฌ ุงูุชูุฑูุฑ</h3>
                    <div id="report-time-info" style="color: #666; font-size: 14px;"></div>
                </div>
                
                <!-- Summary Cards -->
                <div class="report-summary">
                    <div class="summary-card">
                        <div class="summary-icon">๐</div>
                        <div class="summary-value" id="report-total-jobs">0</div>
                        <div class="summary-label">ุฅุฌูุงูู ุงูุทูุจุงุช</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">๐ฐ</div>
                        <div class="summary-value" id="report-total-revenue">$0</div>
                        <div class="summary-label">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">โ</div>
                        <div class="summary-value" id="report-delivered">0</div>
                        <div class="summary-label">ุชู ุงูุชุณููู</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">๐</div>
                        <div class="summary-value" id="report-avg-price">$0</div>
                        <div class="summary-label">ูุชูุณุท ุงูุณุนุฑ</div>
                    </div>
                </div>
                
                <!-- Comparison with Previous Period -->
                <div id="report-comparison" class="comparison-section" style="display: none;">
                    <h3>๐ ุงูููุงุฑูุฉ ูุน ุงููุชุฑุฉ ุงูุณุงุจูุฉ</h3>
                    <div class="comparison-cards">
                        <div class="comparison-card">
                            <div class="comparison-label">ุงูุทูุจุงุช</div>
                            <div class="comparison-value" id="comparison-jobs">-</div>
                        </div>
                        <div class="comparison-card">
                            <div class="comparison-label">ุงูุฅูุฑุงุฏุงุช</div>
                            <div class="comparison-value" id="comparison-revenue">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-container">
                        <h3>๐ ุงูุฅูุฑุงุฏุงุช ุญุณุจ ููุน ุงูุฌูุงุฒ</h3>
                        <canvas id="device-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>๐ณ ุงูุฅูุฑุงุฏุงุช ุญุณุจ ุทุฑููุฉ ุงูุฏูุน</h3>
                        <canvas id="payment-chart"></canvas>
                    </div>
                </div>
                
                <!-- Best Customers -->
                <div class="best-customers-section">
                    <h3>โญ ุฃูุถู ุงูุนููุงุก</h3>
                    <div class="customers-grid">
                        <div class="customer-card">
                            <div class="customer-label">ุฃูุซุฑ ุทูุจุงุช</div>
                            <div class="customer-name" id="best-customer-count">-</div>
                        </div>
                        <div class="customer-card">
                            <div class="customer-label">ุฃุนูู ุฅูุฑุงุฏุงุช</div>
                            <div class="customer-name" id="best-customer-revenue">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Jobs Table -->
                <div class="report-jobs-section">
                    <h3>๐ ุชูุงุตูู ุงูุทูุจุงุช</h3>
                    <div class="table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>ููุฏ ุงูุชุชุจุน</th>
                                    <th>ุงูุนููู</th>
                                    <th>ููุน ุงูุฌูุงุฒ</th>
                                    <th>ุงูุญุงูุฉ</th>
                                    <th>ุงูุณุนุฑ</th>
                                    <th>ุทุฑููุฉ ุงูุฏูุน</th>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                </tr>
                            </thead>
                            <tbody id="report-jobs-table">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Export Buttons -->
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="exportReport('pdf')">
                        ๐ ุชุตุฏูุฑ PDF
                    </button>
                    <button class="btn btn-primary" onclick="exportReport('excel')">
                        ๐ ุชุตุฏูุฑ Excel
                    </button>
                    <button class="btn btn-secondary" onclick="printReport()">
                        ๐จ๏ธ ุทุจุงุนุฉ
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Settings Section -->
    <section id="settings" class="section">
        <div class="container">
            <h2>โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุธุงู</h2>
            
            <div class="settings-group">
                <h3>๐ฑ ุฑุณุงูุฉ ุงููุงุชุณุงุจ ุงููุฎุตุตุฉ</h3>
                <div class="form-group">
                    <label>ูุงูุจ ุงูุฑุณุงูุฉ</label>
                    <textarea id="whatsapp-template" rows="8" placeholder="ุฃุฏุฎู ูุงูุจ ุงูุฑุณุงูุฉ..."></textarea>
                    <div class="template-help">
                        <p><strong>ูุชุบูุฑุงุช ูุชุงุญุฉ:</strong></p>
                        <ul>
                            <li><code>{tracking_code}</code> - ุฑูู ุงูุชุชุจุน</li>
                            <li><code>{customer_name}</code> - ุงุณู ุงูุนููู</li>
                            <li><code>{device_type}</code> - ููุน ุงูุฌูุงุฒ</li>
                            <li><code>{device_model}</code> - ููุฏูู ุงูุฌูุงุฒ</li>
                            <li><code>{serial_number}</code> - ุงูุฑูู ุงูุชุณูุณูู</li>
                            <li><code>{status}</code> - ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ</li>
                            <li><code>{price_info}</code> - ูุนูููุงุช ุงูุณุนุฑ</li>
                            <li><code>{date}</code> - ุชุงุฑูุฎ ุงูุชุญุฏูุซ</li>
                        </ul>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="saveWhatsAppTemplate()">
                    ๐พ ุญูุธ ุงููุงูุจ
                </button>
            </div>
            
            <div class="settings-group">
                <h3>๐ฑ ุฅุนุฏุงุฏุงุช ุงูุนููุฉ</h3>
                <div class="currency-info">
                    <p><strong>ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ:</strong> ุงูุฏููุงุฑ ุงูุฃูุฑููู ($)</p>
                    <p><strong>ุณุนุฑ ุงูุตุฑู ุงูุญุงูู:</strong> 1 ุฏููุงุฑ = <span id="exchange-rate">90000</span> ููุฑุฉ ูุจูุงููุฉ</p>
                    <p><strong>ููุงุญุธุฉ:</strong> ุฌููุน ุงูุชูุงููู ุชุญูุธ ุจุงูุฏููุงุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Job Details Modal -->
    <div id="job-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="job-details"></div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="loading hidden">
        <div class="spinner"></div>
    </div>

    <script>
        window.ENABLE_MONTHLY_STATS = {{ 'true' if enable_monthly_stats else 'false' }};
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <!-- ุชุณุฌูู Service Worker ูู PWA -->
    <script>
        // ุชุณุฌูู Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('{{ url_for("static", filename="sw.js") }}')
                    .then(registration => {
                        console.log('โ Service Worker ูุณุฌู ุจูุฌุงุญ:', registration.scope);
                        
                        // ุงูุชุญูู ูู ุงูุชุญุฏูุซุงุช
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // ููุงู ุชุญุฏูุซ ุฌุฏูุฏ ูุชุงุญ
                                    if (confirm('ุชุญุฏูุซ ุฌุฏูุฏ ูุชุงุญ! ูู ุชุฑูุฏ ุชุญุฏูุซ ุงูุชุทุจููุ')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('โ ูุดู ุชุณุฌูู Service Worker:', error);
                    });
            });
        }
        
        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุซุจูุช PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ุฅุธูุงุฑ ุฒุฑ ุงูุชุซุจูุช
            const installButton = document.createElement('button');
            installButton.textContent = '๐ฑ ุชุซุจูุช ุงูุชุทุจูู ุนูู ุงููุงุชู';
            installButton.className = 'btn btn-primary';
            installButton.style.cssText = 'position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 15px 30px; font-size: 16px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);';
            installButton.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('โ ุชู ูุจูู ุชุซุจูุช ุงูุชุทุจูู');
                    }
                    deferredPrompt = null;
                    installButton.remove();
                });
            };
            document.body.appendChild(installButton);
        });
    </script>
</body>
</html>

